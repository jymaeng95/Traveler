<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.traveler.mapper.BudgetMapper">
	<resultMap id="BudgetVO" type="com.traveler.domain.BudgetVO">
		<id column="budget_no" property="budget_no" />
		<id column="planNo" property="planNo" />
		<id column="userId" property="userId" />
		<id column="title" property="title" />
		<result column="cat" property="cat" />
		<result column="income" property="income" />
		<result column="expend" property="expend" />
		<result column="total" property="total" />
		<result column="planDate" property="planDate" />
		<result column="descript" property="descript" />
		<result column="is_public" property="is_public" />
		<result column="reg_date" property="reg_date" />
		<collection property="plannerVO"
			ofType="com.traveler.domain.PlannerVO">
			<id column="planNo" property="planNo" />
			<id column="userId" property="userId" />
			<result column="planTitle" property="planTitle" />
			<result column="info" property="info" />
		</collection>
	</resultMap>
	<insert id="insertBudget">
		insert into budget (budget_no, planno,userid,
		title,cat,income,expend,total,planDate,descript,is_public)
		values
		(budget_no.nextval,#{planNo}, #{userId}, #{title}, #{cat}, #{income},
		#{expend}, #{total}, #{planDate},#{descript},#{is_public})
	</insert>

	<select id="readBudget" resultMap="BudgetVO">
		select * from budget
		where
		planno = #{planNo} and userid = #{userId}
	</select>

	<update id="insertAndUpdateBudget">
		merge into budget
		using dual
		on (planNo=#{planNo} and
		userId=#{userId} and title=#{title} and planDate=#{planDate})
		when
		matched then
		update set
		income = #{income}, expend=#{expend},
		total=#{total}, descript = #{descript}, cat =#{cat}, is_public =
		#{is_public}
		when not matched then
		insert
		(budget_no,planNo,userId,title,cat,income,expend,total,descript,planDate,is_public)
		VALUES (budget_no.nextval, #{planNo},#{userId},#{title}, #{cat},
		#{income}, #{expend},#{total},
		#{descript},#{planDate},#{is_public})
	</update>

	<select id="readAllMemberPlanNoIsPublicYes" resultMap="BudgetVO">
		select
		planno, reg_date from budget
		where is_public = 'Y'
		group by planno,
		reg_date
		order by planno asc
	</select>

	<select id="readIsPublicBudget" resultType="Map">
		select min(x) as
		min_inc ,max(x) as max_inc, avg(x) as avg_inc, min(y) as min_exp,
		max(y) as max_exp, avg(y) as avg_exp, min(z) as min_total, max(z) as
		max_total, avg(z) as avg_total
		from (
		select planno, total as z,
		sum(expend) as x, sum(income) as y
		from budget
		where is_public='Y'
		group
		by planno, total
		order by planno, total asc
		)
	</select>
	<select id="readIsPublicCat" resultType="Map">
		select cat, count(cat) as count_cat
		from budget
		where is_public ='Y'
		group by cat
		order by cat
	</select>

</mapper>