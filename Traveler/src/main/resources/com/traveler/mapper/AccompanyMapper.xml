<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.traveler.mapper.AccompanyMapper">
	<!-- id-column : DB컬럼명 property : 객체멤버변수 명  -->
	<!-- result : 기본키 이외 멤버변수 지정 -->
<resultMap id="AccompanyVO" type="com.traveler.domain.AccompanyVO">
	<id column="bno" property="bno"/>
	<id column="userId" property="userId"/>
	<result column="planNo" property="planNo"/>
	<result column="numperson" property="numperson"/>
	<result column="curperson" property="curperson"/>	
	<result column="title" property="title"/>
	<result column="planDate" property="planDate"/>
	<result column="planTotalDate" property="planTotalDate"/>
	<result column="content" property="content"/>
	<result column="writeDate" property="writeDate"/>
	<result column="pageNum" property="pageNum"/>
	<result column="type" property="type"/>
	<result column="keyword" property="keyword"/>	
	<collection  property="memberVO" ofType="com.traveler.domain.MemberVO">
		<id column="userId" property="userId"/>
		<result column="userPw" property="userPw"/>
		<result column="email" property="email"/>
		<result column="nickname" property="nickname"/>
		<result column="is_kakao" property="is_kakao"/>
	</collection>
</resultMap>
	
	<!-- 게시판 불러오기 -->
	<select id="boardPaging" resultMap="AccompanyVO">
		<![CDATA[
   		select *
   		from
   			(
   			select /*+INDEX_DESC(accompany bno)*/
   				rownum rn, bno, planNo, numperson, curperson, userId, title, planDate, planTotalDate, content, writeDate
   			from accompany 
   			where
   		]]>

 		<include refid="criteria"></include>
		
 		<![CDATA[
   			rownum <= #{pageNum} * 10
   			)
   		where rn > (#{pageNum} - 1) * 10
   		order by bno desc
   		]]>
	</select>

	<!-- 내 글 불러오기 -->
	<select id="readMine" resultMap="AccompanyVO">
		<![CDATA[
 		select *
 		from
 			(
 			select /*+INDEX_DESC(accompany bno)*/
 				rownum rn, bno, planNo, numperson, curperson, userId, title, planDate, planTotalDate, content, writeDate
 			from accompany
 			where rownum <= #{pageNum} * 10 
 			)
 		where rn > (#{pageNum} - 1) * 10 and userId = #{userId} and #{boardtype} = 'mine'
 		order by bno desc
 		]]>
	</select>
	<!-- 글 불러오기 -->
	<select id="readAcc" resultMap="AccompanyVO">
		select * from accompany
		where bno = #{bno}
	</select>
	
	<insert id="insertAcc">
		insert into accompany (bno,userId,title,planDate, planTotalDate, content, numperson, planNo)
		values (bno.nextval, #{userId}, #{title}, #{planDate}, #{planTotalDate}, #{content}, #{numperson}, #{planNo})
	</insert>
	
	<select id="countforPaging" resultType="int">
		select count(bno) 
		from accompany
		where
  		<include refid="criteria"></include>
		bno > 0
	</select>
	<select id="countforPaging2" resultType="int">
		select count(bno) 
		from accompany
		where
		bno > 0 and userId = #{userId} and #{boardtype} = 'mine'
	</select>
	
	<delete id="deleteAcc">
		delete 
		from accompany
		where bno = #{bno}
	</delete>
	<update id="updateAcc">
		update accompany
		set	title = #{title}, content = #{content}, numperson = #{numperson}
		where bno = #{bno}
	</update>
	
	<select id="iswritten" resultType="int">
		select count(*) from accompany 
		where planNo = #{planNo}
	</select>
	

	<sql id="criteria">
		<trim prefix="(" suffix=") AND " prefixOverrides="OR">
			<choose>
				<when test="type == 'T'.toString()">
					title like '%'||#{keyword}||'%'
				</when>
				<when test="type == 'C'.toString()">
					content like '%'||#{keyword}||'%'
				</when>
				<when test="type == 'W'.toString()">
					userId like '%'||#{keyword}||'%'
				</when>
			</choose>
		</trim>
	</sql>
	
</mapper>